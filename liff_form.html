<!-- v1.4 Appointment App - Updated Message Format -->
<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>預約資料確認</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- 引入 LINE LIFF SDK -->
    <script charset="utf-8" src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
    <style>
        .fade-in { animation: fadeIn 0.3s ease-out; }
        @keyframes fadeIn { from { opacity: 0; transform: scale(0.95); } to { opacity: 1; transform: scale(1); } }
        /* 讀取中遮罩 */
        #loadingOverlay { backdrop-filter: blur(2px); }
    </style>
</head>
<body class="bg-gray-100 min-h-screen font-sans">

    <!-- 1. 主填寫表單區域 -->
    <div id="mainForm" class="max-w-md mx-auto bg-white min-h-screen flex flex-col shadow-lg transition-all duration-300">
        
        <!-- 標題 -->
        <div class="bg-[#06C755] text-white p-4 flex items-center justify-center relative shadow-md">
            <h1 class="text-lg font-bold">線上預約服務</h1>
            <!-- 版本號顯示 -->
            <div class="absolute top-0 right-0 p-2 text-[10px] text-white/70 font-mono">v1.4</div>
        </div>

        <!-- 歡迎詞與使用者資訊 -->
        <div class="p-6 bg-green-50 border-b border-green-100">
            <div class="flex items-center gap-3 mb-2">
                <img id="userAvatar" src="https://via.placeholder.com/40" class="w-10 h-10 rounded-full border-2 border-white shadow-sm hidden">
                <div>
                    <p class="text-sm text-gray-600">哈囉，<span id="lineName" class="font-bold text-gray-800">載入中...</span></p>
                    <p class="text-xs text-gray-500">請填寫下方預約資訊</p>
                </div>
            </div>
        </div>

        <!-- 輸入欄位 -->
        <div class="p-6 flex-1">
            <div class="space-y-6">
                
                <!-- UID 顯示欄位 (唯讀) -->
                <div>
                    <label class="block text-sm font-medium text-gray-500 mb-2">
                        <i class="fa-solid fa-id-card text-gray-400 mr-2"></i>LINE UID
                    </label>
                    <input type="text" id="uidInput" value="等待讀取..." readonly
                        class="w-full px-4 py-3 bg-gray-200 border border-gray-300 rounded-xl text-gray-500 cursor-not-allowed text-sm font-mono focus:outline-none">
                </div>

                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">
                        <i class="fa-solid fa-user text-green-600 mr-2"></i>姓名
                    </label>
                    <input type="text" id="nameInput" placeholder="請輸入您的姓名" 
                        class="w-full px-4 py-3 bg-gray-50 border border-gray-200 rounded-xl focus:bg-white focus:border-[#06C755] focus:ring-2 focus:ring-green-100 outline-none transition-all">
                </div>

                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">
                        <i class="fa-solid fa-phone text-green-600 mr-2"></i>聯絡電話
                    </label>
                    <input type="tel" id="phoneInput" placeholder="0912345678" 
                        class="w-full px-4 py-3 bg-gray-50 border border-gray-200 rounded-xl focus:bg-white focus:border-[#06C755] focus:ring-2 focus:ring-green-100 outline-none transition-all">
                </div>

                <!-- 指定治療師 (下拉選單) -->
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">
                        <i class="fa-solid fa-user-doctor text-green-600 mr-2"></i>指定治療師
                    </label>
                    <div class="relative">
                        <select id="therapistInput" class="w-full px-4 py-3 bg-gray-50 border border-gray-200 rounded-xl focus:bg-white focus:border-[#06C755] focus:ring-2 focus:ring-green-100 outline-none transition-all appearance-none">
                            <option value="不指定">不指定</option>
                            <option value="aa">aa</option>
                            <option value="bb">bb</option>
                            <option value="cc">cc</option>
                        </select>
                        <div class="absolute inset-y-0 right-0 flex items-center px-4 pointer-events-none text-gray-500">
                            <i class="fa-solid fa-chevron-down text-xs"></i>
                        </div>
                    </div>
                </div>

                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">
                        <i class="fa-solid fa-clock text-green-600 mr-2"></i>三個希望預約時間、時段
                    </label>
                    <input type="text" id="timeInput" placeholder="例如：平日晚上 / 週六下午 / 9月10日"
                        class="w-full px-4 py-3 bg-gray-50 border border-gray-200 rounded-xl focus:bg-white focus:border-[#06C755] focus:ring-2 focus:ring-green-100 outline-none transition-all">
                </div>
            </div>

            <!-- 第一步按鈕群組 -->
            <div class="mt-8 flex flex-col gap-3">
                <!-- 送出預覽 -->
                <button onclick="showConfirmation()" class="w-full bg-[#06C755] hover:bg-[#05b34c] text-white font-bold py-3.5 rounded-xl shadow-lg transform active:scale-95 transition-all flex items-center justify-center gap-2">
                    <span>送出預覽</span>
                    <i class="fa-solid fa-arrow-right"></i>
                </button>
                
                <!-- 新增：首頁的取消按鈕 -->
                <button onclick="handleCancel()" class="w-full bg-gray-100 hover:bg-red-50 text-red-500 font-bold py-3.5 rounded-xl transition-all flex items-center justify-center gap-2 border border-transparent hover:border-red-200">
                    <i class="fa-solid fa-xmark"></i>
                    <span>取消預約</span>
                </button>
            </div>
        </div>
    </div>

    <!-- 2. 確認彈窗 (Confirmation Modal) -->
    <div id="confirmModal" class="fixed inset-0 bg-gray-900 bg-opacity-60 hidden z-40 flex items-center justify-center p-4 backdrop-blur-sm">
        <div class="bg-white rounded-2xl shadow-2xl w-full max-w-sm fade-in overflow-hidden relative">
            
            <!-- 彈窗標題 -->
            <div class="bg-gray-100 px-6 py-4 border-b flex items-center gap-2">
                <i class="fa-solid fa-circle-info text-blue-500 text-lg"></i>
                <h3 class="font-bold text-gray-800 text-lg">資料確認</h3>
            </div>
            
            <!-- 資料顯示區 -->
            <div class="p-6 space-y-4">
                <p class="text-gray-500 text-sm">請確認您的預約資訊是否正確：</p>
                <div class="space-y-3 bg-gray-50 p-4 rounded-xl border border-gray-100">
                    <div class="flex flex-col">
                        <span class="text-xs text-gray-400">姓名</span>
                        <span id="displayName" class="font-bold text-gray-800 text-lg"></span>
                    </div>
                    <div class="flex flex-col border-t border-gray-200 pt-2">
                        <span class="text-xs text-gray-400">電話</span>
                        <span id="displayPhone" class="font-bold text-gray-800 text-lg"></span>
                    </div>
                    <div class="flex flex-col border-t border-gray-200 pt-2">
                        <span class="text-xs text-gray-400">指定治療師</span>
                        <span id="displayTherapist" class="font-bold text-gray-800 text-lg text-green-600"></span>
                    </div>
                    <div class="flex flex-col border-t border-gray-200 pt-2">
                        <span class="text-xs text-gray-400">預約時間</span>
                        <span id="displayTime" class="font-bold text-gray-800 text-lg"></span>
                    </div>
                </div>
            </div>

            <!-- 按鈕群組 -->
            <div class="p-4 bg-gray-50 flex flex-col gap-3 border-t">
                <!-- 確認送出 -->
                <button onclick="confirmSubmit()" class="w-full bg-[#06C755] hover:bg-[#05b34c] text-white font-bold py-3 rounded-xl shadow transition-colors flex items-center justify-center gap-2">
                    <i class="fa-solid fa-check"></i> 確認送出
                </button>
                
                <div class="flex gap-3">
                    <!-- 修改 -->
                    <button onclick="editData()" class="flex-1 bg-yellow-500 hover:bg-yellow-600 text-white font-bold py-2.5 rounded-xl shadow transition-colors flex items-center justify-center gap-2">
                        <i class="fa-solid fa-pen"></i> 修改
                    </button>
                    <!-- 取消預約 (連結到 handleCancel) -->
                    <button onclick="handleCancel()" class="flex-1 bg-red-500 hover:bg-red-600 text-white font-bold py-2.5 rounded-xl shadow transition-colors flex items-center justify-center gap-2">
                        <i class="fa-solid fa-trash"></i> 取消預約
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- 3. Loading 遮罩 -->
    <div id="loadingOverlay" class="fixed inset-0 bg-black/40 hidden z-50 flex items-center justify-center">
        <div class="bg-white p-6 rounded-2xl shadow-2xl flex flex-col items-center gap-4">
            <i class="fa-solid fa-circle-notch fa-spin text-[#06C755] text-4xl"></i>
            <span class="text-gray-700 font-bold">資料傳送中...</span>
        </div>
    </div>

    <!-- 4. 結果頁面 (取代 Alert) -->
    <div id="resultPage" class="hidden fixed inset-0 bg-white z-50 flex flex-col items-center justify-center p-8 text-center fade-in">
        <div id="resultIcon" class="text-6xl mb-6 transition-all"></div>
        <h2 id="resultTitle" class="text-2xl font-bold mb-3 text-gray-800"></h2>
        <p id="resultDesc" class="text-gray-600 mb-8 leading-relaxed"></p>
        <button onclick="liff.closeWindow()" class="px-8 py-3 bg-gray-800 text-white rounded-xl shadow-lg hover:bg-gray-700 transition-colors">
            關閉視窗
        </button>
    </div>

    <script>
        // 設定區
        // 部署新版本 GAS 後，請確認此網址是否需要更新
        const GAS_URL = 'https://script.google.com/macros/s/AKfycbwcv9O12WtL5LSBcfJLw-7jZrJoXZkiWeH5uR-3BBhKQNK_-YQokJKGUERRO06pJale/exec'; 
        const MY_LIFF_ID = '2008806287-HtVIW9IQ';

        let userProfile = {
            userId: '',
            displayName: '貴賓'
        };

        // DOM 元素
        const mainForm = document.getElementById('mainForm');
        const confirmModal = document.getElementById('confirmModal');
        const loadingOverlay = document.getElementById('loadingOverlay');
        const resultPage = document.getElementById('resultPage');

        // 輸入框
        const nameInput = document.getElementById('nameInput');
        const phoneInput = document.getElementById('phoneInput');
        const therapistInput = document.getElementById('therapistInput');
        const timeInput = document.getElementById('timeInput');
        const uidInput = document.getElementById('uidInput');

        // 顯示區
        const displayName = document.getElementById('displayName');
        const displayPhone = document.getElementById('displayPhone');
        const displayTherapist = document.getElementById('displayTherapist');
        const displayTime = document.getElementById('displayTime');

        // 結果頁元素
        const resultIcon = document.getElementById('resultIcon');
        const resultTitle = document.getElementById('resultTitle');
        const resultDesc = document.getElementById('resultDesc');

        // 初始化 LIFF
        window.onload = function() {
            initializeLiff(MY_LIFF_ID);
        };

        function initializeLiff(liffId) {
            liff.init({
                liffId: liffId
            }).then(() => {
                if (!liff.isInClient() && !liff.isLoggedIn()) {
                    liff.login();
                } else {
                    liff.getProfile().then(profile => {
                        userProfile = profile;
                        document.getElementById('lineName').textContent = profile.displayName;
                        
                        if(profile.pictureUrl) {
                            const avatar = document.getElementById('userAvatar');
                            avatar.src = profile.pictureUrl;
                            avatar.classList.remove('hidden');
                        }

                        // 填入 UID
                        uidInput.value = profile.userId;
                        uidInput.classList.remove('text-gray-800', 'font-bold');

                        // 一取得個資，立刻紀錄「已訪問」(瀏覽中)
                        logVisit(profile.userId, profile.displayName);

                    }).catch(err => {
                        console.error('Profile Error', err);
                        uidInput.value = "無法抓取 UID: " + err;
                    });
                }
            }).catch((err) => {
                alert('LIFF 初始化失敗：' + err);
            });
        }

        function logVisit(uid, lineName) {
            const payload = {
                action: 'visit', 
                uid: uid,
                displayName: lineName
            };
            fetch(GAS_URL, {
                method: 'POST',
                mode: 'no-cors',
                headers: { 'Content-Type': 'text/plain;charset=utf-8' },
                body: JSON.stringify(payload)
            }).catch(console.error);
        }

        // --- 功能：顯示結果頁面 (統一處理) ---
        function showResultPage(type) {
            // 隱藏其他所有視窗
            mainForm.classList.add('hidden');
            confirmModal.classList.add('hidden');
            loadingOverlay.classList.add('hidden');
            
            // 顯示結果頁
            resultPage.classList.remove('hidden');

            if (type === 'success') {
                resultIcon.className = 'fa-solid fa-circle-check text-[#06C755] text-7xl mb-6';
                resultTitle.textContent = '已送出預約訊息';
                resultDesc.innerHTML = '待人工處理，會再與您聯繫<br>您現在可以關閉此視窗';
            } else {
                resultIcon.className = 'fa-solid fa-circle-xmark text-gray-400 text-7xl mb-6';
                resultTitle.textContent = '已取消';
                resultDesc.innerHTML = '已取消預約申請<br>您現在可以關閉此頁面';
            }
            
            // 嘗試關閉視窗 (如果環境支援，使用者可能根本看不到這頁，直接關閉)
            setTimeout(() => {
                liff.closeWindow();
            }, 500); // 延遲一點點讓畫面有機會渲染
        }

        // --- 功能：處理取消預約 ---
        function handleCancel() {
            if (!userProfile.userId) {
                liff.closeWindow();
                return;
            }

            // 顯示 Loading
            loadingOverlay.classList.remove('hidden');

            const payload = {
                action: 'cancel',
                uid: userProfile.userId,
                displayName: userProfile.displayName
            };

            fetch(GAS_URL, {
                method: 'POST',
                mode: 'no-cors',
                headers: { 'Content-Type': 'text/plain;charset=utf-8' },
                body: JSON.stringify(payload)
            }).finally(() => {
                // 不管成功失敗，都顯示取消結果頁
                showResultPage('cancel');
            });
        }

        // --- 第一步：顯示確認視窗 ---
        function showConfirmation() {
            const uid = uidInput.value;
            if (uid === '等待讀取...' || uid.startsWith('無法')) {
                alert('尚未抓取到 LINE 使用者資料，請重新整理頁面');
                return;
            }
            if (!nameInput.value || !phoneInput.value || !timeInput.value) {
                alert('請完整填寫所有欄位');
                return;
            }

            displayName.textContent = nameInput.value;
            displayPhone.textContent = phoneInput.value;
            displayTherapist.textContent = therapistInput.value;
            displayTime.textContent = timeInput.value;

            confirmModal.classList.remove('hidden');
        }

        function editData() {
            confirmModal.classList.add('hidden');
        }

        // --- 按鈕動作：確認送出 ---
        function confirmSubmit() {
            confirmModal.classList.add('hidden');
            loadingOverlay.classList.remove('hidden');

            const payload = {
                action: 'submit', 
                uid: userProfile.userId,
                displayName: userProfile.displayName,
                name: nameInput.value,
                phone: phoneInput.value,
                therapist: therapistInput.value, 
                time: timeInput.value
            };

            fetch(GAS_URL, {
                method: 'POST',
                mode: 'no-cors',
                headers: { 'Content-Type': 'text/plain;charset=utf-8' },
                body: JSON.stringify(payload)
            }).then(() => {
                sendLineMessageAndClose(payload.name, payload.phone, payload.therapist, payload.time);
            }).catch(err => {
                console.error(err);
                alert('資料傳送失敗，請檢查網路');
                loadingOverlay.classList.add('hidden');
            });
        }

        function sendLineMessageAndClose(name, phone, therapist, time) {
            // 這裡傳送的是 "使用者" 身分送出的訊息 (對話紀錄)
            const msg = `姓名: ${name}\n電話: ${phone}\n指定治療師: ${therapist}\n期望預約時間: ${time}`;

            if (liff.isInClient()) {
                liff.sendMessages([{ type: 'text', text: msg }])
                    .then(() => {
                        // 訊息發送成功後，顯示結果頁並嘗試關閉
                        showResultPage('success');
                    })
                    .catch((err) => {
                        console.error('訊息發送失敗', err);
                        // 失敗也顯示結果頁(至少資料有送給GAS)
                        showResultPage('success');
                    });
            } else {
                // 外部瀏覽器，直接顯示結果頁
                showResultPage('success');
            }
        }
    </script>
</body>
</html>
