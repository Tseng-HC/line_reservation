<!-- ver0.09 æ­£å¼æº–å‚™ç‰ˆ -->
<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>é ç´„æ²»ç™‚å¸«</title>
    <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body { visibility: hidden; }
        #loading { visibility: visible; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: white; display: flex; justify-content: center; align-items: center; z-index: 999; }
    </style>
</head>
<body class="bg-gray-50 p-6 relative">

    <!-- ç‰ˆæœ¬è™Ÿ -->
    <div class="absolute top-2 right-2 text-xs text-gray-400 font-mono bg-gray-200 px-2 py-1 rounded">ver0.09</div>

    <!-- Loading -->
    <div id="loading">
        <div class="text-center">
            <div class="animate-spin rounded-full h-10 w-10 border-b-2 border-green-500 mx-auto mb-4"></div>
            <p class="text-gray-500">è¼‰å…¥é ç´„ç³»çµ±...</p>
        </div>
    </div>

    <!-- é ç´„é¢æ¿ -->
    <div class="max-w-md mx-auto bg-white rounded-lg shadow-lg p-6 space-y-6 mt-4">
        <h1 class="text-2xl font-bold text-center text-green-700">é ç´„æ²»ç™‚å¸«</h1>
        
        <div class="p-4 bg-green-50 rounded-lg border border-green-100 text-sm text-green-800">
            <p>ğŸ‘‹ <span id="user-name" class="font-bold">è¨ªå®¢</span> æ‚¨å¥½ï¼</p>
            <p class="mt-1">ç³»çµ±å·²è‡ªå‹•ç™»å…¥ï¼Œæ‚¨å¯ä»¥é–‹å§‹å¡«å¯«é ç´„è¡¨å–®ã€‚</p>
        </div>

        <div class="space-y-4">
            <!-- é€™è£¡é ç•™çµ¦è¡¨å–®æ¬„ä½ -->
            <div class="h-32 bg-gray-100 rounded flex items-center justify-center text-gray-400 border-dashed border-2">
                (é ç´„è¡¨å–®å€åŸŸ)
            </div>
            
            <button id="btn-reply" onclick="sendTestReply()" class="w-full py-3 bg-gray-600 text-white rounded hover:bg-gray-700 transition">
                æ¸¬è©¦ API å›è¦† (é™¤éŒ¯ç”¨)
            </button>
        </div>
    </div>

    <script>
        const LIFF_ID = '2008806287-jfDxgE50'; 
        const GAS_URL = 'https://script.google.com/macros/s/AKfycbwcNsPso4DX3T87JhPjgR32pw804dUF0CbwlpiAUBMr4l-HibOtCUYMHPs9UtaA4-khzw/exec';

        window.onload = function() {
            initializeLiff();
        };

        async function initializeLiff() {
            try {
                await liff.init({ liffId: LIFF_ID });
                
                if (!liff.isLoggedIn()) {
                    liff.login();
                    return; 
                }

                // å–å¾—ä½¿ç”¨è€…è³‡æ–™
                const idToken = liff.getDecodedIDToken();
                const uid = idToken.sub;
                const displayName = idToken.name || "ç”¨æˆ¶";
                
                // é¡¯ç¤ºåå­—åœ¨ç•«é¢ä¸Š
                document.getElementById('user-name').textContent = displayName;

                // 1. éœé»˜å‚³é€è³‡æ–™çµ¦ GAS (ç´€éŒ„æ™‚é–“ã€UIDã€åç¨±)
                fetch(GAS_URL, {
                    method: 'POST',
                    mode: 'no-cors',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        type: 'track_open',
                        uid: uid,
                        name: displayName
                    })
                });

                // 2. æ„åœ–å®£å‘Šï¼šç™¼é€ "é ç´„æ²»ç™‚å¸«"
                // åƒ…åœ¨æ‰‹æ©Ÿ/LINE App å…§åŸ·è¡Œï¼Œé¿å…é›»è…¦ç‰ˆå ±éŒ¯
                if (liff.isInClient()) {
                    await liff.sendMessages([{
                        type: 'text',
                        text: 'é ç´„æ²»ç™‚å¸«'
                    }]);
                }

                // é¡¯ç¤ºç•«é¢
                document.body.style.visibility = 'visible';
                document.getElementById('loading').style.display = 'none';

            } catch (error) {
                alert('åˆå§‹åŒ–éŒ¯èª¤: ' + error);
                document.body.style.visibility = 'visible'; // å‡ºéŒ¯ä¹Ÿè¦é¡¯ç¤ºï¼Œä¸ç„¶æœƒç™½ç•«é¢
                document.getElementById('loading').style.display = 'none';
            }
        }

        async function sendTestReply() {
            if (!liff.isInClient()) {
                alert('æ­¤åŠŸèƒ½åƒ…é™ LINE App å…§ä½¿ç”¨');
                return;
            }
            try {
                await liff.sendMessages([{
                    type: 'text',
                    text: 'APIå›è¦†æ¸¬è©¦'
                }]);
                liff.closeWindow();
            } catch (error) {
                alert('ç™¼é€å¤±æ•—: ' + error);
            }
        }
    </script>
</body>
</html>
