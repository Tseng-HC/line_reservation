<!-- ver0.03 測試簡化版 -->
<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>連線測試</title>
    <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body { visibility: hidden; }
        #loading { visibility: visible; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: white; display: flex; justify-content: center; align-items: center; z-index: 999; }
    </style>
</head>
<body class="bg-gray-100 p-6 relative">

    <!-- 版本號顯示 (右上角) -->
    <div class="absolute top-2 right-2 text-xs text-gray-400 font-mono bg-gray-200 px-2 py-1 rounded">ver0.03 Test</div>

    <!-- Loading -->
    <div id="loading">
        <div class="text-center">
            <div class="animate-spin rounded-full h-10 w-10 border-b-2 border-blue-500 mx-auto mb-4"></div>
            <p>測試連線中...</p>
        </div>
    </div>

    <!-- 測試面板 -->
    <div class="max-w-md mx-auto bg-white rounded-lg shadow p-6 space-y-6 mt-6">
        <h1 class="text-xl font-bold text-center text-blue-600">系統連線測試</h1>
        
        <div class="p-4 bg-gray-50 rounded text-sm text-gray-600 space-y-2">
            <p>1. 網頁開啟時，自動傳送資料給 GAS。</p>
            <p>2. 網頁開啟時，自動在聊天室發送「訊息發送測試」。</p>
        </div>

        <hr>

        <div class="text-center">
            <p class="mb-2 text-gray-700 font-medium">手動測試 API 回覆</p>
            <button onclick="sendTestReply()" class="w-full py-3 bg-blue-600 text-white rounded hover:bg-blue-700 transition">
                點擊發送 "API回覆測試"
            </button>
            <p class="text-xs text-gray-400 mt-2">點擊後，請關閉視窗查看機器人是否有回應</p>
        </div>
    </div>

    <script>
        // 設定區 (請確認您的 LIFF ID 和 GAS URL)
        const LIFF_ID = '2008806287-jfDxgE50'; 
        const GAS_URL = 'https://script.google.com/macros/s/AKfycbwcNsPso4DX3T87JhPjgR32pw804dUF0CbwlpiAUBMr4l-HibOtCUYMHPs9UtaA4-khzw/exec';

        window.onload = function() {
            initializeLiff();
        };

        async function initializeLiff() {
            try {
                await liff.init({ liffId: LIFF_ID });
                
                if (!liff.isLoggedIn()) {
                    liff.login();
                    return;
                }

                // 1. 測試：傳送資料到 GAS (靜默)
                fetch(GAS_URL, {
                    method: 'POST',
                    mode: 'no-cors',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        type: 'test_connection',
                        data1: 'GAS資料傳送測試欄位1',
                        data2: 'GAS資料傳送測試欄位2',
                        data3: 'GAS資料傳送測試欄位3'
                    })
                });

                // 2. 測試：自動發送訊息 (意圖宣告)
                if (liff.getContext().type !== 'none') {
                    await liff.sendMessages([{
                        type: 'text',
                        text: '訊息發送測試'
                    }]);
                }

                // 顯示畫面
                document.body.style.visibility = 'visible';
                document.getElementById('loading').style.display = 'none';

            } catch (error) {
                alert('初始化錯誤: ' + error);
                document.body.style.visibility = 'visible';
                document.getElementById('loading').style.display = 'none';
            }
        }

        async function sendTestReply() {
            try {
                await liff.sendMessages([{
                    type: 'text',
                    text: 'API回覆測試'
                }]);
                liff.closeWindow(); 
            } catch (error) {
                alert('發送失敗: ' + error);
            }
        }
    </script>
</body>
</html>
